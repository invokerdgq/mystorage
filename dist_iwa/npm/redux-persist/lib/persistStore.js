"use strict";exports.__esModule=!0;var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t};exports.default=persistStore;var _redux=require("../../redux/lib/redux.js"),_persistReducer=require("./persistReducer.js"),_persistReducer2=_interopRequireDefault(_persistReducer),_constants=require("./constants.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}var initialState={registry:[],bootstrapped:!1},persistorReducer=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:initialState,e=arguments[1];switch(e.type){case _constants.REGISTER:return _extends({},t,{registry:[].concat(_toConsumableArray(t.registry),[e.key])});case _constants.REHYDRATE:var r=t.registry.indexOf(e.key),s=[].concat(_toConsumableArray(t.registry));return s.splice(r,1),_extends({},t,{registry:s,bootstrapped:0===s.length});default:return t}};function persistStore(n,t,e){var a=e||!1,i=(0,_redux.createStore)(persistorReducer,initialState,t?t.enhancer:void 0),r=function(t){i.dispatch({type:_constants.REGISTER,key:t})},s=function(t,e,r){var s={type:_constants.REHYDRATE,payload:e,err:r,key:t};n.dispatch(s),i.dispatch(s),a&&o.getState().bootstrapped&&(a(),a=!1)},o=_extends({},i,{purge:function(){var e=[];return n.dispatch({type:_constants.PURGE,result:function(t){e.push(t)}}),Promise.all(e)},flush:function(){var e=[];return n.dispatch({type:_constants.FLUSH,result:function(t){e.push(t)}}),Promise.all(e)},pause:function(){n.dispatch({type:_constants.PAUSE})},persist:function(){n.dispatch({type:_constants.PERSIST,register:r,rehydrate:s})}});return o.persist(),o}