"use strict";var utils=require("./utils.js"),formats=require("./formats.js"),has=Object.prototype.hasOwnProperty,arrayPrefixGenerators={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,r){return e+"["+r+"]"},repeat:function(e){return e}},isArray=Array.isArray,push=Array.prototype.push,pushToArray=function(e,r){push.apply(e,isArray(r)?r:[r])},toISO=Date.prototype.toISOString,defaults={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:utils.encode,encodeValuesOnly:!1,formatter:formats.formatters[formats.default],indices:!1,serializeDate:function(e){return toISO.call(e)},skipNulls:!1,strictNullHandling:!1},stringify=function e(r,t,o,a,i,n,s,l,f,u,d,c,y){var p=r;if("function"==typeof s?p=s(t,p):p instanceof Date?p=u(p):"comma"===o&&isArray(p)&&(p=p.join(",")),null===p){if(a)return n&&!c?n(t,defaults.encoder,y):t;p=""}if("string"==typeof p||"number"==typeof p||"boolean"==typeof p||utils.isBuffer(p))return n?[d(c?t:n(t,defaults.encoder,y))+"="+d(n(p,defaults.encoder,y))]:[d(t)+"="+d(String(p))];var m,h=[];if(void 0===p)return h;if(isArray(s))m=s;else{var v=Object.keys(p);m=l?v.sort(l):v}for(var g=0;g<m.length;++g){var b=m[g];i&&null===p[b]||(isArray(p)?pushToArray(h,e(p[b],"function"==typeof o?o(t,b):t,o,a,i,n,s,l,f,u,d,c,y)):pushToArray(h,e(p[b],t+(f?"."+b:"["+b+"]"),o,a,i,n,s,l,f,u,d,c,y)))}return h},normalizeStringifyOptions=function(e){if(!e)return defaults;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var r=e.charset||defaults.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=formats.default;if(void 0!==e.format){if(!has.call(formats.formatters,e.format))throw new TypeError("Unknown format option provided.");t=e.format}var o=formats.formatters[t],a=defaults.filter;return("function"==typeof e.filter||isArray(e.filter))&&(a=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:defaults.addQueryPrefix,allowDots:void 0===e.allowDots?defaults.allowDots:!!e.allowDots,charset:r,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:defaults.charsetSentinel,delimiter:void 0===e.delimiter?defaults.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:defaults.encode,encoder:"function"==typeof e.encoder?e.encoder:defaults.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:defaults.encodeValuesOnly,filter:a,formatter:o,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:defaults.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:defaults.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:defaults.strictNullHandling}};module.exports=function(e,r){var t,o=e,a=normalizeStringifyOptions(r);"function"==typeof a.filter?o=(0,a.filter)("",o):isArray(a.filter)&&(t=a.filter);var i,n=[];if("object"!=typeof o||null===o)return"";i=r&&r.arrayFormat in arrayPrefixGenerators?r.arrayFormat:r&&"indices"in r?r.indices?"indices":"repeat":"indices";var s=arrayPrefixGenerators[i];t||(t=Object.keys(o)),a.sort&&t.sort(a.sort);for(var l=0;l<t.length;++l){var f=t[l];a.skipNulls&&null===o[f]||pushToArray(n,stringify(o[f],f,s,a.strictNullHandling,a.skipNulls,a.encode?a.encoder:null,a.filter,a.sort,a.allowDots,a.serializeDate,a.formatter,a.encodeValuesOnly,a.charset))}var u=n.join(a.delimiter),d=!0===a.addQueryPrefix?"?":"";return a.charsetSentinel&&("iso-8859-1"===a.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),0<u.length?d+u:""};