"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index);require("../npm/@tarojs/async-await/index.js");var _index3=require("../api/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../utils/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var u=e.apply(this,arguments);return new Promise(function(o,i){return function t(e,r){try{var n=u[e](r),a=n.value}catch(e){return void i(e)}if(!n.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});o(a)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var globalData={},TOKEN_IDENTIFIER="auth_token",TOKEN_TIMESTAMP="refresh_token_time";function remove(e,t){var r=e.indexOf(t);0<=r&&e.splice(r,1)}function isAsync(e){var t=e.toString().trim();return!!(t.match(/^async /)||t.match(/return _ref[^.]*\.apply/)||e.then)}var Spx=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.hooks=[],this.options=_extends({autoRefreshToken:!0},e),this.options.autoRefreshToken&&this.startRefreshToken()}var r,n,e;return _createClass(t,[{key:"getAuthToken",value:function(){var e=_index2.default.getStorageSync(TOKEN_IDENTIFIER);return e&&!this.get(TOKEN_IDENTIFIER)&&this.set(TOKEN_IDENTIFIER,e),e}},{key:"setAuthToken",value:function(e){this.set(TOKEN_IDENTIFIER,e),_index2.default.setStorageSync(TOKEN_IDENTIFIER,e),_index2.default.setStorageSync(TOKEN_TIMESTAMP,Date.now()+33e5)}},{key:"startRefreshToken",value:function(){var o=this;this._refreshTokenTimer&&clearTimeout(this._refreshTokenTimer);var e,t=(e=_asyncToGenerator(getApp().regeneratorRuntime.mark(function e(){var t,r,n,a;return getApp().regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_index2.default.getStorageSync(TOKEN_TIMESTAMP)){e.next=3;break}return e.abrupt("return");case 3:if(0<(r=t-Date.now())&&r<=3e5)return e.next=7,_index4.default.user.refreshToken();e.next=11;break;case 7:n=e.sent,a=n.token,clearTimeout(o._refreshTokenTimer),o.setAuthToken(a);case 11:case"end":return e.stop()}},e,o)})),function(){return e.apply(this,arguments)});setInterval(t,3e5)}},{key:"getUserInfo",value:(e=_asyncToGenerator(getApp().regeneratorRuntime.mark(function e(){var t,r;return getApp().regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.get("userInfo"),r=this.getAuthToken(),!t&&r)return e.next=5,_index4.default.user.info();e.next=7;break;case 5:t=e.sent,this.set("userInfo",t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"get",value:function(e){return globalData[e]}},{key:"set",value:function(e,t){globalData[e]=t}},{key:"hasHook",value:function(e){return void 0!==this.hooks[e]}},{key:"trigger",value:(n=_asyncToGenerator(getApp().regeneratorRuntime.mark(function e(t){for(var r=arguments.length,n=Array(1<r?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];var o,i,u,s,c,f,l,h,p;return getApp().regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.hooks[t]){e.next=3;break}return e.abrupt("return");case 3:i=[],s=!(u=!0),c=void 0,e.prev=7,f=o[Symbol.iterator]();case 9:if(u=(l=f.next()).done){e.next=23;break}if(isAsync(h=l.value))return e.next=14,h.apply(this,n);e.next=17;break;case 14:e.t0=e.sent,e.next=18;break;case 17:e.t0=h.apply(this,n);case 18:p=e.t0,i.push(p);case 20:u=!0,e.next=9;break;case 23:e.next=29;break;case 25:e.prev=25,e.t1=e.catch(7),s=!0,c=e.t1;case 29:e.prev=29,e.prev=30,!u&&f.return&&f.return();case 32:if(e.prev=32,s)throw c;e.next=35;break;case 35:return e.finish(32);case 36:return e.finish(29);case 37:return e.abrupt("return",i);case 38:case"end":return e.stop()}},e,this,[[7,25,29,37],[30,,32,36]])})),function(e){return n.apply(this,arguments)})},{key:"bind",value:function(e,t){var r=this.hooks[e]||[];r.push(t),this.hooks[e]=r}},{key:"unbind",value:function(e,t){var r=this.hooks[e];r&&remove(r,t)}},{key:"autoLogin",value:(r=_asyncToGenerator(getApp().regeneratorRuntime.mark(function e(t,r){var n;return getApp().regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.trigger("autoLogin",t);case 3:if(this.getAuthToken()){e.next=5;break}throw new Error("auth token not found");case 5:return e.next=7,this.getUserInfo();case 7:if(n=e.sent,r)return e.next=11,r(n);e.next=11;break;case 11:if(n){e.next=13;break}throw new Error("userInfo is empty");case 13:return e.abrupt("return",n);case 16:e.prev=16,e.t0=e.catch(0),_index5.log.debug("[auth failed] redirect to login page: ",e.t0),this.login(t);case 20:case"end":return e.stop()}},e,this,[[0,16]])})),function(e,t){return r.apply(this,arguments)})},{key:"login",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],r=(0,_index5.getCurrentRoute)(e.$router),n=r.path,a=r.fullPath,o=encodeURIComponent(a);if("/pages/auth/login"!==n){var i="/pages/auth/login?redirect="+o;_index2.default[t?"redirectTo":"navigateTo"]({url:i})}}},{key:"logout",value:function(){_index2.default.removeStorageSync(TOKEN_IDENTIFIER),delete globalData[TOKEN_IDENTIFIER],this.trigger("logout")}},{key:"globalData",value:function(){return null}},{key:"toast",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];_index2.default.eventCenter.trigger.apply(_index2.default.eventCenter,["sp-toast:show"].concat(t))}},{key:"closeToast",value:function(){_index2.default.eventCenter.trigger("sp-toast:close")}}]),t}();exports.default=new Spx;