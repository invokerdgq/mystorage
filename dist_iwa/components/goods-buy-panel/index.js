"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,a)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(a):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../utils/index.js"),_index4=require("../../api/index.js"),_index5=_interopRequireDefault(_index4);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(o,s){return function t(e,n){try{var a=r[e](n),i=a.value}catch(e){return void s(e)}if(!a.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});o(i)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var GoodsBuyPanel=(_temp2=_class=function(e){function s(){var e,t,d,a,y=this;_classCallCheck(this,s);for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=d=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(i)))).$usedState=["anonymousState__temp","anonymousState__temp4","anonymousState__temp5","anonymousState__temp6","anonymousState__temp7","info","loopArray0","curImg","curSku","noSpecs","maxStore","quantity","type","hasStore","busy","fastBuyText","marketing","selection","isActive","__fn_onChange","__fn_onAddCart","__fn_onFastbuy","isOpened"],d.getSkuProps=function(){if(!d.props.info)return"";var e=d.state.curSku;return d.noSpecs?"":e?"已选 “"+e.propsText+"”":"请选择"},d.handleQuantityChange=function(e){d.setState({quantity:e})},d.handleSelectSku=function(e,t){if(!(d.props.info.spec_items.length<=1||d.disabledSet.has(e.spec_value_id))){var n=d.state.selection;n[t]===e.spec_value_id?n[t]=null:n[t]=e.spec_value_id,d.updateCurSku(n),d.setState({selection:n})}},d.toggleShow=function(e){void 0===e&&(e=!d.state.isActive),d.setState({isActive:e}),d.props.onClose&&d.__triggerPropsFn("onClose",[null].concat([]))},d.handleBuyClick=(a=_asyncToGenerator(getApp().regeneratorRuntime.mark(function e(t,n,a){var i,o,s,r,u,l,c,_,p,f;return getApp().regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=d.state,o=i.marketing,s=i.info,r=d.noSpecs?s:n,u=r.item_id,l="/pages/cart/espier-checkout","cart"===t)return l="/pages/cart/espier-index",e.prev=5,e.next=8,_index5.default.cart.add({item_id:u,num:a});e.next=16;break;case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(5),console.log(e.t0);case 13:_index2.default.showToast({title:"成功加入购物车",icon:"success"}),d.setState({busy:!1}),d.__triggerPropsFn("onAddCart",[null].concat([u,a]));case 16:if("fastbuy"!==t){e.next=41;break}if(l+="?cart_type=fastbuy","group"!==o){e.next=23;break}c=s.group_activity.groups_activity_id,l+="&type="+o+"&group_id="+c,e.next=30;break;case 23:if("seckill"===o)return _=s.seckill_activity.seckill_id,e.next=27,_index5.default.item.seckillCheck({item_id:u,seckill_id:_,num:a});e.next=30;break;case 27:p=e.sent,f=p.ticket,l+="&type="+o+"&seckill_id="+_+"&ticket="+f;case 30:return e.prev=30,e.next=33,_index5.default.cart.fastBuy({item_id:u,num:a});case 33:e.next=38;break;case 35:e.prev=35,e.t1=e.catch(30),console.log(e.t1);case 38:d.setState({busy:!1}),d.__triggerPropsFn("onFastbuy",[null].concat([u,a])),_index2.default.navigateTo({url:l});case 41:case"end":return e.stop()}},e,y,[[5,10],[30,35]])})),function(e,t,n){return a.apply(this,arguments)}),d.$$refs=[],_possibleConstructorReturn(d,t)}return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.state={marketing:"normal",selection:[],curSku:null,curImg:null,quantity:1,isActive:e.isOpened},this.disabledSet=new Set}},{key:"componentDidMount",value:function(){var e=this.props.info,t=e.spec_items,n=e.group_activity?"group":e.seckill_activity?"seckill":"normal",a={};t.forEach(function(e){var t=e.item_spec.map(function(e){return e.spec_value_id}).join("_"),n=e.item_spec.map(function(e){return e.spec_value_name}).join(" ");e.propsText=n,a[t]=e});var i=Array(e.item_spec_desc.length).fill(null);this.skuDict=a,this.setState({marketing:n,selection:i}),t&&t.length||(this.noSpecs=!0)}},{key:"componentWillReceiveProps",value:function(e){var t=e.isOpened;t!==this.state.isActive&&this.setState({isActive:t})}},{key:"calcDisabled",value:function(e){for(var i=this.skuDict,t=new Set,n=function(e,t,n){var a=function(e,n,a){var t=e.slice().map(function(e,t){return n===t?a:e||"(\\d+)"}).join("_");return new RegExp(t)}(e,t,n);return Object.keys(i).some(function(e){return e.match(a)&&0<i[e].store})},a=this.props.info,o=0,s=a.item_spec_desc.length;o<s;o++)for(var r=a.item_spec_desc[o].spec_values,u=0,l=r.length;u<l;u++){var c=r[u].spec_value_id;t.has(c)||n(e,o,c)||t.add(c)}this.disabledSet=t}},{key:"getCurSkuImg",value:function(e){var t=this.props.info.pics[0];return e&&e.item_spec.some(function(e){if(e.spec_image_url)return t=e.spec_image_url,!0}),t}},{key:"updateCurSku",value:function(e){if(e=e||this.state.selection,this.calcDisabled(e),e.some(function(e){return!e}))return this.setState({curSku:null,curImg:null}),void this.__triggerPropsFn("onChange",[null].concat([null]));var t=this.skuDict[e.join("_")],n=this.getCurSkuImg(t);this.setState({curSku:t,curImg:n}),this.__triggerPropsFn("onChange",[null].concat([t])),_index3.log.debug("[goods-buy-panel] updateCurSku: ",t)}},{key:"_createData",value:function(){var n=this;this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var e=this.noSpecs,t=this.__props,a=t.info,i=t.type,o=t.fastBuyText,s=this.__state,r=(s.curImg,s.quantity,s.selection),u=s.isActive,l=s.busy;if(!a)return null;var c=this.noSpecs?a:this.__state.curSku,_=+(c?c.store:a.store||99999),p=c?0<c.store:0<a.store,f=(0,_index3.classNames)("goods-buy-panel",u?"goods-buy-panel__active":null);this.anonymousFunc0=function(){return n.toggleShow(!1)};var d="cart"===i||"all"===i&&p?(0,_index3.classNames)("goods-buy-panel__btn btn-add-cart",{"is-disabled":!c}):null,y="cart"===i||"all"===i&&p?Boolean(!c):null,m="fastbuy"===i||"all"===i&&p?(0,_index3.classNames)("goods-buy-panel__btn btn-fast-buy",{"is-disabled":!c}):null,v="fastbuy"===i||"all"===i&&p?Boolean(!c):null,h=a.item_spec_desc.map(function(e,t){return{$anonymousCallee__0:(e={$original:(0,_index.internal_get_original)(e)}).$original.spec_values.map(function(e){return e={$original:(0,_index.internal_get_original)(e)},{$loopState__temp3:(0,_index3.classNames)("sku-item",{"is-active":e.$original.spec_value_id===r[t],"is-disabled":n.disabledSet.has(e.$original.spec_value_id)}),$original:e.$original}}),$original:e.$original}});return Object.assign(this.__state,{anonymousState__temp:f,anonymousState__temp4:d,anonymousState__temp5:y,anonymousState__temp6:m,anonymousState__temp7:v,info:a,loopArray0:h,noSpecs:e,maxStore:_,type:i,hasStore:p,busy:l,fastBuyText:o}),this.__state}},{key:"anonymousFunc0",value:function(e){}}]),s}(),_class.properties={info:{type:null,value:null},__fn_onChange:{type:null,value:null},onClose:{type:null,value:null},__fn_onClose:{type:null,value:null},__fn_onAddCart:{type:null,value:null},__fn_onFastbuy:{type:null,value:null},type:{type:null,value:null},fastBuyText:{type:null,value:null},isOpened:{type:null,value:null}},_class.$$events=["anonymousFunc0","handleSelectSku","handleQuantityChange","handleBuyClick"],_class.options={addGlobalClass:!0},_class.defaultProps={info:null,isOpened:!1,type:"fastbuy",fastBuyText:"立即购买",busy:!1,onClose:function(){},onChange:function(){},onClickAddCart:function(){},onClickFastBuy:function(){}},_temp2);exports.default=GoodsBuyPanel,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(GoodsBuyPanel));